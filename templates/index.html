{% extends '_layout1.html' %}
{% load static %}

{% block head_title %}
    {{ titulo }}
{% endblock %}

{% block content %}
    <div class="container mt-4">
        {# Mensagens de erro ou sucesso do Django #}
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <h1>{{ titulo }}</h1>

        {% for post in artigo %}
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="card-title">{{ post.titulo_blog }}</h2>
                    <p class="card-text">Por: {{ post.author }} em {{ post.pub_date|date:"d/m/Y" }}</p>
                    <p class="card-text">{{ post.conteudo_artigo|safe }}</p>

                    <hr>
                    <button class="btn btn-primary toggle-comments-btn" type="button" data-post-id="{{ post.id }}">
                        Exibir Comentários ({{ post.approved_comments_list|length }})
                    </button>

                    <div id="comments-{{ post.id }}" class="comments-section" style="display: none;">
                        <h4 class="mt-3">Comentários</h4>
                        {% if post.approved_comments_list %}
                            <ul class="list-unstyled">
                                {% for comment in post.approved_comments_list %}
                                    <li class="mb-2">
                                        <strong>{{ comment.name }}</strong> em {{ comment.created_at|date:"d M Y H:i" }}
                                        <p>{{ comment.comment }}</p>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Nenhum comentário aprovado ainda.</p>
                        {% endif %}

                        <hr>
                        <div class="comment-form-container">
                            <h4 class="mt-3">Adicionar um Comentário</h4>
                            <form method="post" action="{% url 'addcomment' post.id %}">
                                {% csrf_token %}
                                {% if user.is_authenticated %}
                                    <p>Comentando como: <strong>{{ user.username }}</strong></p>
                                    {% else %}
                                    <div class="mb-3">
                                        <label for="id_name" class="form-label">Seu Nome:</label>
                                        <input type="text" class="form-control" id="id_name" name="name" required>
                                    </div>
                                {% endif %}
                                <div class="mb-3">
                                    <label for="id_comment" class="form-label">Seu Comentário:</label>
                                    <textarea class="form-control" id="id_comment" name="comment" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-success">Enviar Comentário</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        {% if artigo.has_other_pages %}
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if artigo.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page={{ artigo.previous_page_number }}">Anterior</a></li>
                    {% endif %}
                    {% for page_num in artigo.paginator.page_range %}
                        {% if artigo.number == page_num %}
                            <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a></li>
                        {% endif %}
                    {% endfor %}
                    {% if artigo.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ artigo.next_page_number }}">Próxima</a></li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    </div>
{% endblock %}

{% block javascript %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var buttons = document.querySelectorAll('.toggle-comments-btn');

            buttons.forEach(function(button) {
                button.addEventListener('click', function() {
                    var postId = this.getAttribute('data-post-id');
                    var commentsSection = document.getElementById('comments-' + postId);
                    var buttonText = this.textContent;

                    if (commentsSection.style.display === 'none' || commentsSection.style.display === '') {
                        commentsSection.style.display = 'block';
                        this.textContent = 'Ocultar Comentários';
                    } else {
                        commentsSection.style.display = 'none';
                        var commentCount = buttonText.match(/\((.*?)\)/);
                        if (commentCount) {
                            this.textContent = 'Exibir Comentários ' + commentCount[0];
                        } else {
                            this.textContent = 'Exibir Comentários';
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}